<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7-Lane Road Simulation</title>
    <style>
        /* General page styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #1a1a1a; /* Dark background for better contrast */
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #e0e0e0;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        h1, h2 {
            text-align: center;
            color: #ffffff;
            font-weight: 300;
        }

        /* Main container for the simulation elements */
        #simulation-container {
            width: 95%;
            max-width: 1200px;
            margin: 40px 0;
        }

        /* New container for the road and its curved ramps */
        #road-area {
            position: relative;
            padding-right: 60px; /* Make space for the ramps on the right */
        }

        /* The road itself */
        #road {
            display: flex;
            width: 100%;
            height: 75vh; /* 75% of the viewport height */
            background-color: #333; /* Asphalt color */
            border-left: 4px solid #f0b429; /* Yellow edge line */
            border-right: 4px solid #f0b429; /* Yellow edge line */
            position: relative; /* Crucial for positioning cars absolutely */
            overflow: hidden; /* Cars will disappear cleanly when they exit */
            border-radius: 8px;
        }

        .lane {
            flex: 1; /* Each lane takes up an equal amount of width */
            height: 100%;
            border-right: 2px dashed #888; /* Lane divider */
            position: relative;
            box-sizing: border-box;
        }

        .lane:last-child {
            border-right: none;
        }

        /* The special green lane for ambulances */
        .green-lane {
            background-color: rgba(38, 166, 154, 0.4); /* Translucent green */
        }

        /* Visuals for the curved in/out paths */
        .path-curve {
            position: absolute;
            width: 120px;
            height: 120px;
            border: 4px solid #f0b429;
            border-radius: 50%;
            right: -64px; /* Position to overlap the road edge slightly */
            z-index: -1; /* Place it behind the road */
        }

        #exit-curve {
            top: -64px; /* Position at the top right */
            border-bottom-color: transparent;
            border-left-color: transparent;
            transform: rotate(45deg); /* Create the curve shape */
        }

        #entry-curve {
            bottom: -64px; /* Position at the bottom right */
            border-top-color: transparent;
            border-left-color: transparent;
            transform: rotate(225deg); /* Create the curve shape */
        }


        /* Vehicle Styles */
        .car, .ambulance {
            position: absolute;
            width: 65%; /* 65% of the lane's width */
            height: 60px; /* Fixed height for consistency */
            left: 50%;
            transform: translateX(-50%); /* Center the car horizontally */
            bottom: -100px; /* Start off-screen */
            box-sizing: border-box;
            border-radius: 10px 10px 4px 4px; /* Car-like shape */
            box-shadow: 0 4px 8px rgba(0,0,0,0.6);
            /* Removed transition for direct JS control, which is smoother */
        }
        
        .car::before, .ambulance::before { /* Windshield */
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            height: 20px;
            background: rgba(100, 150, 200, 0.5);
            border-radius: 8px 8px 2px 2px;
            border-bottom: 2px solid rgba(0,0,0,0.2);
        }

        /* Unique colors for cars in each lane */
        #lane-1 .car { background-color: #d90429; } /* Red */
        #lane-2 .car { background-color: #0077b6; } /* Blue */
        #lane-3 .car { background-color: #fca311; } /* Orange */
        #lane-5 .car { background-color: #8ac926; } /* Light Green */
        #lane-6 .car { background-color: #6a00f4; } /* Purple */
        #lane-7 .car { background-color: #ffc600; } /* Yellow */

        .ambulance {
            background-color: #f1f1f1;
            border: 3px solid #e63946;
            z-index: 10; /* Ensure it's visible on top of other elements */
        }

        /* Simple "flashing light" for the ambulance */
        .ambulance::after {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 12px;
            background-color: #00aeff;
            border-radius: 50%;
            animation: flash 1s infinite;
        }

        @keyframes flash {
            0%, 100% { background-color: #00aeff; box-shadow: 0 0 8px #00aeff, 0 0 12px #fff; }
            50% { background-color: #e63946; box-shadow: 0 0 8px #e63946, 0 0 12px #fff; }
        }


        /* Control Box Styles */
        #control-box {
            width: 95%;
            max-width: 1200px;
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: grid;
            /* Responsive grid for controls */
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .lane-controls {
            border: 1px solid #444;
            border-radius: 5px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .lane-controls h3 {
            margin: 0 0 15px 0;
            text-align: center;
            font-weight: 400;
        }

        .lane-controls label {
            margin-top: 10px;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
        }
        
        .lane-controls .value-display {
            font-weight: bold;
            color: #f0b429;
        }

        input[type="range"] {
            width: 100%;
            cursor: pointer;
        }

        #lane-4-controls {
            background-color: rgba(38, 166, 154, 0.2);
            border-color: rgba(38, 166, 154, 0.8);
        }
    </style>
</head>
<body>

    <h1>Road Traffic Simulator</h1>

    <div id="simulation-container">
        <div id="road-area">
            
            <div id="road">
                <!-- Lanes are the containers for cars -->
                <div class="lane" id="lane-1"></div>
                <div class="lane" id="lane-2"></div>
                <div class="lane" id="lane-3"></div>
                <div class="lane green-lane" id="lane-4"></div>
                <div class="lane" id="lane-5"></div>
                <div class="lane" id="lane-6"></div>
                <div class="lane" id="lane-7"></div>
            </div>
            
        </div>
    </div>

    <div id="control-box">
        <h2>Control Panel</h2>
        <div class="lane-controls">
            <h3>Lane 1</h3>
            <label for="speed-1">Speed: <span id="speed-val-1" class="value-display">5</span></label>
            <input type="range" id="speed-1" min="0" max="15" value="5">
            <label for="cars-1">Traffic Flow: <span id="cars-val-1" class="value-display">3</span></label>
            <input type="range" id="cars-1" min="0" max="15" value="3">
        </div>
        <div class="lane-controls">
            <h3>Lane 2</h3>
            <label for="speed-2">Speed: <span id="speed-val-2" class="value-display">6</span></label>
            <input type="range" id="speed-2" min="0" max="15" value="6">
            <label for="cars-2">Traffic Flow: <span id="cars-val-2" class="value-display">2</span></label>
            <input type="range" id="cars-2" min="0" max="15" value="2">
        </div>
        <div class="lane-controls">
            <h3>Lane 3</h3>
            <label for="speed-3">Speed: <span id="speed-val-3" class="value-display">4</span></label>
            <input type="range" id="speed-3" min="0" max="15" value="4">
            <label for="cars-3">Traffic Flow: <span id="cars-val-3" class="value-display">4</span></label>
            <input type="range" id="cars-3" min="0" max="15" value="4">
        </div>
        <div class="lane-controls" id="lane-4-controls">
            <h3>Lane 4 (Ambulance)</h3>
            <label for="speed-4">Speed: <span id="speed-val-4" class="value-display">10</span></label>
            <input type="range" id="speed-4" min="0" max="25" value="10">
            <label for="cars-4">Traffic Flow: <span id="cars-val-4" class="value-display">1</span></label>
            <input type="range" id="cars-4" min="0" max="15" value="1">
        </div>
        <div class="lane-controls">
            <h3>Lane 5</h3>
            <label for="speed-5">Speed: <span id="speed-val-5" class="value-display">5</span></label>
            <input type="range" id="speed-5" min="0" max="15" value="5">
            <label for="cars-5">Traffic Flow: <span id="cars-val-5" class="value-display">3</span></label>
            <input type="range" id="cars-5" min="0" max="15" value="3">
        </div>
        <div class="lane-controls">
            <h3>Lane 6</h3>
            <label for="speed-6">Speed: <span id="speed-val-6" class="value-display">7</span></label>
            <input type="range" id="speed-6" min="0" max="15" value="7">
            <label for="cars-6">Traffic Flow: <span id="cars-val-6" class="value-display">2</span></label>
            <input type="range" id="cars-6" min="0" max="15" value="2">
        </div>
        <div class="lane-controls">
            <h3>Lane 7</h3>
            <label for="speed-7">Speed: <span id="speed-val-7" class="value-display">4</span></label>
            <input type="range" id="speed-7" min="0" max="15" value="4">
            <label for="cars-7">Traffic Flow: <span id="cars-val-7" class="value-display">3</span></label>
            <input type="range" id="cars-7" min="0" max="15" value="3">
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const road = document.getElementById('road');
            let roadHeight = road.clientHeight;
            const lanes = [];
            const NUM_LANES = 7;

            // Constants for car properties and physics
            const CAR_HEIGHT = 60; // Must match CSS
            const SAFE_BUFFER = 30; // Min space between cars
            const MAX_SPAWN_INTERVAL = 6000; // Max time between spawns (6s)
            const MIN_SPAWN_INTERVAL = 300;  // Min time between spawns (0.3s)

            // ----- INITIALIZATION -----

            for (let i = 1; i <= NUM_LANES; i++) {
                lanes.push({
                    id: i,
                    element: document.getElementById(`lane-${i}`),
                    speedControl: document.getElementById(`speed-${i}`),
                    numControl: document.getElementById(`cars-${i}`),
                    speedValDisplay: document.getElementById(`speed-val-${i}`),
                    carsValDisplay: document.getElementById(`cars-val-${i}`),
                    trafficFlow: 0,
                    currentSpeed: 0,
                    cars: [] // Stores car objects { element, y }
                });
            }

            lanes.forEach(lane => {
                // Function to read and apply slider settings
                function updateLaneSettings() {
                    lane.trafficFlow = parseInt(lane.numControl.value);
                    lane.currentSpeed = parseInt(lane.speedControl.value);
                    lane.speedValDisplay.textContent = lane.currentSpeed;
                    lane.carsValDisplay.textContent = lane.trafficFlow;
                }

                lane.speedControl.addEventListener('input', updateLaneSettings);
                lane.numControl.addEventListener('input', updateLaneSettings);
                
                updateLaneSettings(); // Set initial values
                startCarSpawner(lane); // Start the spawner loop for this lane
            });

            // Recalculate road height on window resize for responsiveness
            window.addEventListener('resize', () => {
                roadHeight = road.clientHeight;
            });

            // ----- CAR SPAWNING LOGIC -----

            function startCarSpawner(lane) {
                let spawnInterval = 7000; // Default long interval if flow is 0
                if (lane.trafficFlow > 0) {
                    const maxSliderVal = parseInt(lane.numControl.max);
                    const flowRatio = lane.trafficFlow / maxSliderVal;
                    // Higher traffic flow means a shorter interval
                    spawnInterval = MAX_SPAWN_INTERVAL - (flowRatio * (MAX_SPAWN_INTERVAL - MIN_SPAWN_INTERVAL));
                    // Add randomness for a more natural feel
                    spawnInterval += (Math.random() - 0.5) * 500;
                    spawnInterval = Math.max(MIN_SPAWN_INTERVAL, spawnInterval);
                }

                setTimeout(() => {
                    if (lane.trafficFlow > 0) {
                        tryToCreateCar(lane);
                    }
                    startCarSpawner(lane); // Schedule the next spawn attempt
                }, spawnInterval);
            }
            
            function tryToCreateCar(lane) {
                // Check if the spawn point is clear to avoid instant collisions
                const isSpawnPointClear = !lane.cars.some(car => car.y < CAR_HEIGHT);
                if (isSpawnPointClear) {
                    createCarInstance(lane);
                }
            }

            function createCarInstance(lane) {
                const carElement = document.createElement('div');
                const isAmbulance = (lane.id === 4);
                carElement.classList.add(isAmbulance ? 'ambulance' : 'car');
                
                const car = {
                    element: carElement,
                    y: -CAR_HEIGHT, // Start just off the bottom of the screen
                };

                carElement.style.bottom = `${car.y}px`;
                lane.element.appendChild(carElement);
                lane.cars.push(car);
            }


            // ----- ANIMATION & PHYSICS LOOP -----

            function gameLoop() {
                lanes.forEach(lane => {
                    // Sort cars by position for accurate collision detection
                    lane.cars.sort((a, b) => b.y - a.y);

                    const carsToRemove = [];

                    lane.cars.forEach((car, index) => {
                        // 1. Calculate proposed new position
                        let newY = car.y + lane.currentSpeed;

                        // 2. Check for collision with car in front
                        if (index > 0) {
                            const carInFront = lane.cars[index - 1];
                            const safeDistance = carInFront.y - CAR_HEIGHT - SAFE_BUFFER;
                            if (newY > safeDistance) {
                                newY = safeDistance; // Brake to avoid collision
                            }
                        }

                        // 3. Update car's actual position
                        car.y = newY;
                        car.element.style.bottom = `${car.y}px`;

                        // 4. Check for exit
                        if (car.y > roadHeight) {
                            carsToRemove.push(car);
                        }
                    });

                    // 5. Remove cars that have exited the road
                    if (carsToRemove.length > 0) {
                        carsToRemove.forEach(car => car.element.remove());
                        lane.cars = lane.cars.filter(car => !carsToRemove.includes(car));
                    }
                });

                requestAnimationFrame(gameLoop); // Continue the animation loop
            }

            // Start the simulation!
            requestAnimationFrame(gameLoop);
        });
    </script>

</body>
</html>

