<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8-Lane Road Simulation with Traffic Lights</title>
    <style>
        /* General page styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #1a1a1a;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        h1, h2 {
            text-align: center;
            color: #ffffff;
            font-weight: 300;
        }

        #simulation-container {
            width: 95%;
            max-width: 1200px;
            margin: 20px 0;
            position: relative;
        }

        #traffic-light-container {
            display: flex;
            width: 100%;
            padding-bottom: 10px;
        }

        .traffic-light {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            background: #111;
            padding: 5px 0;
            border-radius: 20px;
            margin: 0 1px;
        }
        
        .light {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: #444;
            opacity: 0.3;
        }
        
        .light.red.active { background-color: #ff1c1c; opacity: 1; box-shadow: 0 0 10px #ff1c1c; }
        .light.yellow.active { background-color: #ffc700; opacity: 1; box-shadow: 0 0 10px #ffc700; }
        .light.green.active { background-color: #00ff00; opacity: 1; box-shadow: 0 0 10px #00ff00; }

        #road {
            display: flex;
            width: 100%;
            height: 75vh;
            background-color: #333;
            border: 4px solid #f0b429;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
        }
        
        #stop-line {
            position: absolute;
            width: 100%;
            height: 5px;
            background-color: white;
            top: 20%; /* Position of the stop line from the top */
            z-index: 5;
        }

        .lane {
            flex: 1;
            height: 100%;
            border-right: 2px dashed #888;
            position: relative;
            box-sizing: border-box;
        }

        .lane:last-child {
            border-right: none;
        }

        .green-lane {
            background-color: rgba(38, 166, 154, 0.4);
        }

        /* New Repair Lane styling */
        #lane-8 {
            background: repeating-linear-gradient(
                45deg,
                #444,
                #444 10px,
                #555 10px,
                #555 20px
            );
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #lane-8 .lane-label {
            transform: rotate(-90deg);
            font-size: 2em;
            font-weight: bold;
            color: rgba(255, 255, 0, 0.7);
            letter-spacing: 5px;
            text-transform: uppercase;
        }

        /* Vehicle Styles */
        .car, .ambulance {
            position: absolute;
            width: 65%;
            height: 60px;
            left: 50%;
            transform: translateX(-50%);
            bottom: -100px;
            box-sizing: border-box;
            border-radius: 10px 10px 4px 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.6);
        }
        
        .car::before, .ambulance::before { /* Windshield */
            content: '';
            position: absolute;
            top: 5px; left: 5px; right: 5px;
            height: 20px;
            background: rgba(100, 150, 200, 0.5);
            border-radius: 8px 8px 2px 2px;
            border-bottom: 2px solid rgba(0,0,0,0.2);
        }

        /* Unique colors for cars in each lane */
        #lane-1 .car { background-color: #d90429; } /* Red */
        #lane-2 .car { background-color: #0077b6; } /* Blue */
        #lane-3 .car { background-color: #fca311; } /* Orange */
        #lane-5 .car { background-color: #8ac926; } /* Light Green */
        #lane-6 .car { background-color: #6a00f4; } /* Purple */
        #lane-7 .car { background-color: #ffc600; } /* Yellow */
        #lane-8 .car { background-color: #999; } /* Grey for repair lane */


        .ambulance {
            background-color: #f1f1f1;
            border: 3px solid #e63946;
            z-index: 10;
        }

        .ambulance::after {
            content: '';
            position: absolute;
            top: -6px; left: 50%;
            transform: translateX(-50%);
            width: 12px; height: 12px;
            background-color: #00aeff;
            border-radius: 50%;
            animation: flash 1s infinite;
        }

        @keyframes flash {
            0%, 100% { background-color: #00aeff; box-shadow: 0 0 8px #00aeff; }
            50% { background-color: #e63946; box-shadow: 0 0 8px #e63946; }
        }

        #control-box {
            width: 95%;
            max-width: 1200px;
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .lane-controls {
            border: 1px solid #444;
            border-radius: 5px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .lane-controls h3 {
            margin: 0 0 15px 0; text-align: center; font-weight: 400;
        }
        .lane-controls label {
            margin-top: 10px; font-size: 0.9em;
            display: flex;
            justify-content: space-between;
        }
        .lane-controls .value-display {
            font-weight: bold; color: #f0b429;
        }
        input[type="range"] {
            width: 100%; cursor: pointer;
        }

        #lane-4-controls {
            background-color: rgba(38, 166, 154, 0.2);
            border-color: rgba(38, 166, 154, 0.8);
        }
        
        #lane-8-controls {
             background-color: rgba(100, 100, 100, 0.2);
             border-color: #888;
             justify-content: center;
             align-items: center;
             font-size: 1.2em;
        }

    </style>
</head>
<body>

    <h1>8-Lane Road Simulation</h1>

    <div id="simulation-container">
        <div id="traffic-light-container"></div>
        <div id="road">
            <div id="stop-line"></div>
            <div class="lane" id="lane-1"></div>
            <div class="lane" id="lane-2"></div>
            <div class="lane" id="lane-3"></div>
            <div class="lane green-lane" id="lane-4"></div>
            <div class="lane" id="lane-5"></div>
            <div class="lane" id="lane-6"></div>
            <div class="lane" id="lane-7"></div>
            <div class="lane" id="lane-8"><span class="lane-label">Repair</span></div>
        </div>
    </div>

    <div id="control-box">
        <h2>Control Panel</h2>
        <div class="lane-controls">
            <h3>Lane 1</h3>
            <label>Speed: <span id="speed-val-1" class="value-display">5</span></label>
            <input type="range" id="speed-1" min="0" max="15" value="5">
            <label>Traffic Flow: <span id="cars-val-1" class="value-display">3</span></label>
            <input type="range" id="cars-1" min="0" max="15" value="3">
        </div>
        <div class="lane-controls">
            <h3>Lane 2</h3>
            <label>Speed: <span id="speed-val-2" class="value-display">6</span></label>
            <input type="range" id="speed-2" min="0" max="15" value="6">
            <label>Traffic Flow: <span id="cars-val-2" class="value-display">2</span></label>
            <input type="range" id="cars-2" min="0" max="15" value="2">
        </div>
        <div class="lane-controls">
            <h3>Lane 3</h3>
            <label>Speed: <span id="speed-val-3" class="value-display">4</span></label>
            <input type="range" id="speed-3" min="0" max="15" value="4">
            <label>Traffic Flow: <span id="cars-val-3" class="value-display">4</span></label>
            <input type="range" id="cars-3" min="0" max="15" value="4">
        </div>
        <div class="lane-controls" id="lane-4-controls">
            <h3>Lane 4 (Ambulance)</h3>
            <label>Speed: <span id="speed-val-4" class="value-display">10</span></label>
            <input type="range" id="speed-4" min="0" max="25" value="10">
            <label>Traffic Flow: <span id="cars-val-4" class="value-display">1</span></label>
            <input type="range" id="cars-4" min="0" max="15" value="1">
        </div>
        <div class="lane-controls">
            <h3>Lane 5</h3>
            <label>Speed: <span id="speed-val-5" class="value-display">5</span></label>
            <input type="range" id="speed-5" min="0" max="15" value="5">
            <label>Traffic Flow: <span id="cars-val-5" class="value-display">3</span></label>
            <input type="range" id="cars-5" min="0" max="15" value="3">
        </div>
        <div class="lane-controls">
            <h3>Lane 6</h3>
            <label>Speed: <span id="speed-val-6" class="value-display">7</span></label>
            <input type="range" id="speed-6" min="0" max="15" value="7">
            <label>Traffic Flow: <span id="cars-val-6" class="value-display">2</span></label>
            <input type="range" id="cars-6" min="0" max="15" value="2">
        </div>
        <div class="lane-controls">
            <h3>Lane 7</h3>
            <label>Speed: <span id="speed-val-7" class="value-display">4</span></label>
            <input type="range" id="speed-7" min="0" max="15" value="4">
            <label>Traffic Flow: <span id="cars-val-7" class="value-display">3</span></label>
            <input type="range" id="cars-7" min="0" max="15" value="3">
        </div>
        <div class="lane-controls" id="lane-8-controls">
            <h3>Lane 8 - Repair</h3>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const road = document.getElementById('road');
            let roadHeight = road.clientHeight;
            const lanes = [];
            const NUM_LANES = 8;
            const trafficLightContainer = document.getElementById('traffic-light-container');

            const CAR_HEIGHT = 60;
            const SAFE_BUFFER = 30;
            const MAX_SPAWN_INTERVAL = 6000;
            const MIN_SPAWN_INTERVAL = 300;
            const STOP_LINE_Y_RATIO = 0.8; // Stop at 80% of the way up the road

            for (let i = 1; i <= NUM_LANES; i++) {
                // Create traffic light HTML
                const lightDiv = document.createElement('div');
                lightDiv.className = 'traffic-light';
                lightDiv.innerHTML = `
                    <span class="light red"></span>
                    <span class="light yellow"></span>
                    <span class="light green"></span>`;
                trafficLightContainer.appendChild(lightDiv);

                lanes.push({
                    id: i,
                    element: document.getElementById(`lane-${i}`),
                    speedControl: document.getElementById(`speed-${i}`),
                    numControl: document.getElementById(`cars-${i}`),
                    speedValDisplay: document.getElementById(`speed-val-${i}`),
                    carsValDisplay: document.getElementById(`cars-val-${i}`),
                    trafficFlow: 0,
                    currentSpeed: 0,
                    cars: [],
                    lightState: 'green', // 'red', 'yellow', 'green'
                    lightElements: {
                        red: lightDiv.querySelector('.red'),
                        yellow: lightDiv.querySelector('.yellow'),
                        green: lightDiv.querySelector('.green'),
                    }
                });
            }

            lanes.forEach(lane => {
                if (lane.id === 8) { // Special handling for repair lane
                    lane.currentSpeed = 1;
                    lane.trafficFlow = 5; // Fixed flow
                    startCarSpawner(lane);
                    return;
                }
                function updateLaneSettings() {
                    lane.trafficFlow = parseInt(lane.numControl.value);
                    lane.currentSpeed = parseInt(lane.speedControl.value);
                    lane.speedValDisplay.textContent = lane.currentSpeed;
                    lane.carsValDisplay.textContent = lane.trafficFlow;
                }
                lane.speedControl.addEventListener('input', updateLaneSettings);
                lane.numControl.addEventListener('input', updateLaneSettings);
                updateLaneSettings();
                startCarSpawner(lane);
            });
            
            function setLightState(lane, state) {
                lane.lightState = state;
                Object.values(lane.lightElements).forEach(el => el.classList.remove('active'));
                if (lane.lightElements[state]) {
                    lane.lightElements[state].classList.add('active');
                }
            }
            
            function manageTrafficLights() {
                const cycleTime = 10000; // 10 seconds for green
                const yellowTime = 2000; // 2 seconds for yellow

                // Phase 1: Evens green, Odds red
                lanes.forEach(lane => setLightState(lane, lane.id % 2 === 0 ? 'green' : 'red'));
                
                setTimeout(() => {
                     // Transition: Evens yellow
                     lanes.forEach(lane => { if (lane.id % 2 === 0) setLightState(lane, 'yellow'); });
                }, cycleTime);

                setTimeout(() => {
                    // Phase 2: Odds green, Evens red
                    lanes.forEach(lane => setLightState(lane, lane.id % 2 !== 0 ? 'green' : 'red'));
                }, cycleTime + yellowTime);

                setTimeout(() => {
                    // Transition: Odds yellow
                    lanes.forEach(lane => { if (lane.id % 2 !== 0) setLightState(lane, 'yellow'); });
                }, cycleTime * 2 + yellowTime);
            }
            
            // Initialize and loop the traffic light cycle
            manageTrafficLights();
            setInterval(manageTrafficLights, (10000 + 2000) * 2);


            window.addEventListener('resize', () => { roadHeight = road.clientHeight; });

            function startCarSpawner(lane) {
                let spawnInterval = 7000;
                if (lane.trafficFlow > 0) {
                    const maxSliderVal = lane.numControl ? parseInt(lane.numControl.max) : 15;
                    const flowRatio = lane.trafficFlow / maxSliderVal;
                    spawnInterval = MAX_SPAWN_INTERVAL - (flowRatio * (MAX_SPAWN_INTERVAL - MIN_SPAWN_INTERVAL));
                    spawnInterval += (Math.random() - 0.5) * 500;
                    spawnInterval = Math.max(MIN_SPAWN_INTERVAL, spawnInterval);
                }
                setTimeout(() => {
                    if (lane.trafficFlow > 0) tryToCreateCar(lane);
                    startCarSpawner(lane);
                }, spawnInterval);
            }
            
            function tryToCreateCar(lane) {
                const isSpawnPointClear = !lane.cars.some(car => car.y < CAR_HEIGHT);
                if (isSpawnPointClear) createCarInstance(lane);
            }

            function createCarInstance(lane) {
                const carElement = document.createElement('div');
                const isAmbulance = (lane.id === 4);
                carElement.classList.add(isAmbulance ? 'ambulance' : 'car');
                
                const car = { element: carElement, y: -CAR_HEIGHT };
                carElement.style.bottom = `${car.y}px`;
                lane.element.appendChild(carElement);
                lane.cars.push(car);
            }

            function gameLoop() {
                // const stopLineY = roadHeight * (1 - STOP_LINE_Y_RATIO); // This variable is no longer needed for logic

                lanes.forEach(lane => {
                    lane.cars.sort((a, b) => b.y - a.y);
                    const carsToRemove = [];

                    lane.cars.forEach((car, index) => {
                        let proposedSpeed = lane.currentSpeed;
                        
                        // Traffic light stopping logic has been removed.

                        let newY = car.y + proposedSpeed;

                        // Collision detection
                        if (index > 0) {
                            const carInFront = lane.cars[index - 1];
                            const safeDistance = carInFront.y - CAR_HEIGHT - SAFE_BUFFER;
                            if (newY > safeDistance) {
                                newY = safeDistance;
                            }
                        }

                        car.y = newY;
                        car.element.style.bottom = `${car.y}px`;

                        if (car.y > roadHeight) carsToRemove.push(car);
                    });

                    if (carsToRemove.length > 0) {
                        carsToRemove.forEach(car => car.element.remove());
                        lane.cars = lane.cars.filter(car => !carsToRemove.includes(car));
                    }
                });
                requestAnimationFrame(gameLoop);
            }
            requestAnimationFrame(gameLoop);
        });
    </script>
</body>
</html>


